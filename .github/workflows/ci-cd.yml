# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: Java CI-CD with Maven

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: CI Pipeline

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: maven
      - name: Build with Maven
        run: mvn -B package --file pom.xml


  deploy:
    name: CD Pipeline

    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ 3.8 ]
        node-version: [ '12.x' ]
        appname: [ 'aws-codedeploy' ]
        deploy-group: [ 'staging' ]
        s3-bucket: [ 'aws-codedeploy-deployments-try' ]
        s3-filename: [ 'staging-aws-codedeploy-try-${{ github.sha }}' ]

    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: maven
      - name: Build with Maven
        run: mvn -B package --file pom.xml

      - name: Install python
        uses: actions/setup-python@v2
        with:
          python-version: "3.8"

      - name: Install aws cli
        run: python3 -m pip install --user awscli

      - name: configure aws cli
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      # Deploy push to AWS S3
      - name: AWS Deploy push
        run: |
          aws deploy push \
          --application-name aws-codedeploy \
          --description "This is a revision for the aws-codedeploy-${{ github.sha }}" \
          --ignore-hidden-files \
          --s3-location s3://aws-codedeploy-deployments-try/staging-aws-codedeploy-dc1ad63e3952d6515378dedcc10a91f123544abd.zip \
          --source .

      # Create deployment to CodeDeploy
      - name: AWS Create Deployment
        run: |
          aws deploy create-deployment \
           --application-name aws-codedeploy \
           --deployment-config-name CodeDeployDefault.OneAtATime \
           --deployment-group-name tp-discovery-service \
           --file-exists-behavior OVERWRITE \
           --s3-location bucket=aws-codedeploy-deployments-try,key=staging-aws-codedeploy-dc1ad63e3952d6515378dedcc10a91f123544abd.zip,bundleType=zip \


      - name: Restart supervisor
        uses: appleboy/ssh-action@master
        with:
         HOST: "3.140.252.172"
         USERNAME: "ec2-user"
         PORT: "22"
         KEY:
          "MIIEpAIBAAKCAQEAr1HLMelzkovj9fX9USM+l0wk0KQRO6TCKZ+9iITupcWZ1TSh
           nu0Ho9TyV+UhhRkvA3Out8Kx1lN50zVZT0smsB2nYby380/OCyCp7o/Wf8AkO9iw
           1q14wkfFCoKzz28gsatZJAijXxnW5wpkU10D2pV1JsTD/0C1KO0B0NupUvpzUbP9
           PAaeRDb1u3kZjzXAK2lLNIQuBW4+oG61ATj3KI7VqksfmrxOwNmH35A11VPLemkB
           +UQ2s/XW1r2Pc/z2ZKYULUJqNXu5grW47MA5lmbL2Kg+KEFzzn8Uq+r4SoIDxRVO
           v0nYr1+lmIcx+Ye3bw7sCw3eUxy8qz2ozRQ94wIDAQABAoIBADu1b66gA2x1mD28
           eXmYt0hv9lnYhsX5ZucmMDa+j0iF885ZDnJB58g0ThUBRFlAKnLSgz6yYD7OTz9P
           fAs1XQe+EbOHwl5rX5EKntVQx4zas3xuYEu86NPB/amGuhZ7knbwFHvhNUK+WiJ1
           t5VsqFNZc3ywps/YCdrWXTf0l8ZaVSl2G+CPMop1hZvvm8Tqz/aUNAkdK+x1W+7E
           +FDP8QRZTC9JZKvXB2OKwDsrtFKAuRyqFax3UMkG6RwCHRcM5GXj+MvrKjxqqZlq
           ITdEVuXs8o+Tji5vIcJRURnKw69o9YLuO/U5SC8/JESBEEc1Yr/yarOwxVju0ood
           FWVhvoECgYEA4rEn1vPMeRA1y1nywPP6agIEzRPDg+vNgNay2j7b3bEuDRrleQh2
           QiGjLQCmY9Rra5IiMwYfIJxjiUh7cupeNn31o6lgRfKiplkajK9dWZd5GLOEyRqA
           5k90jfQd+CBmgTxEp1VgSvXX3aW/Al4TI7qqTGGx9z7G+RNbaQorKXcCgYEAxfxb
           pBhjCHbk52HU/BBrulf0+pSJAJuKQa+qJ/OiQ0IKhsOiWRGuP1VqbeNdQWqNlhLQ
           mXj1xYaxG8pSVvkUzOYK7R8W7DPtYDDnZGDsh8rET+eXdn++iChjTp6GAp3xPt2O
           DTk4rV/kaiGzNe9wbOwfIkCgEM8aW59pgOFKqfUCgYBT5Pg3htZ/X05pSYqbei+M
           l96q/st2wQe2zL44Itc/vliqpO+T0VvisYwwFXN+sphmoRhjBbrzWK1FmzuEldP0
           Gr2TqhVlDZzAL22x7xx/EZ3RVG6p9lMJ6RHbjyKgN214GpPV0bTnSQBwmOyNtb8j
           k+t+hRFVzTfZ6h4ES60ZlQKBgQDDWsCp6A4/2eD/ln7rwOArXIKzhkCwwsjnC4gg
           J7wiFVYBp6PXsyR2BbggecoYtCTEwgfmh34qyz6Sp04b12Z4zzxUwOqDYrGEynxn
           hWOekaqnFWNUX7QG8aMbfjvI9UOHvmFeFuof2JCvUFVekMYkE9CcoZvPOitN4Lvf
           mW1syQKBgQCcLD44/Dju34lTXT+BPWMpu/FqXwtqec5OLmuVowXKJH4ZYHvBbA6J
           Cgp4eiZ6Lqv5Nez0fFjRyUhEyfonJ43u5dH+XnhhkBvnOZ6z1WOODQC2AVDr0Y85
           hUEVq+tdduGwQWx51WbzY6Uz6tRFWquTBN3TwsVKY4VDrqslmZ8Q1A=="
         script: |
          sudo supervisorctl restart all
